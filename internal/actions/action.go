// Copyright 2021 VMware, Inc.
// SPDX-License-Identifier: MIT

package actions

import (
	"errors"
	"fmt"
	"strings"

	"gopkg.in/yaml.v3"
)

// ErrInvalidAction occurs when user passes a action that is not one of merge, replace, delete, combine.
var ErrInvalidAction = errors.New("invalid overlay action")

type Action int

const (
	// Invalid overlay action.
	Invalid = iota
	// Merge overlay action.
	Merge
	// Replace overlay action.
	Replace
	// Delete overlay action.
	Delete
	// Combine overlay action.
	Combine
)

func (a Action) String() string {
	toString := map[Action]string{
		Invalid: "",
		Merge:   "merge",
		Replace: "replace",
		Delete:  "delete",
		Combine: "combine",
	}

	return toString[a]
}

func (a *Action) UnmarshalYAML(value *yaml.Node) error {
	var y string

	if err := value.Decode(&y); err != nil {
		return fmt.Errorf("%w at line %d column %d", err, value.Line, value.Column)
	}

	y = strings.ToLower(y)

	toID := map[string]Action{
		"":        Invalid,
		"merge":   Merge,
		"replace": Replace,
		"delete":  Delete,
		"combine": Combine,
	}

	if toID[y] == Invalid {
		return fmt.Errorf("%w, %s", ErrInvalidAction, y)
	}

	*a = toID[y]

	return nil
}

func (a Action) MarshalYAML() (interface{}, error) {
	return a.String(), nil
}

func (a *Action) Set(val string) error {
	if err := yaml.Unmarshal([]byte(val), a); err != nil {
		return fmt.Errorf("%w", err)
	}

	return nil
}

func (a *Action) Type() string {
	return "actions.Action"
}

type OnMissingAction int

const (
	// Ignore onMissing action.
	Ignore = iota
	// Inject onMissing action.
	Inject
)

func (a OnMissingAction) String() string {
	toString := map[OnMissingAction]string{
		Ignore: "ignore",
		Inject: "inject",
	}

	return toString[a]
}

func (a *OnMissingAction) UnmarshalYAML(value *yaml.Node) error {
	var y string

	if err := value.Decode(&y); err != nil {
		return fmt.Errorf("%w at line %d column %d", err, value.Line, value.Column)
	}

	y = strings.ToLower(y)

	toID := map[string]OnMissingAction{
		"ignore": Ignore,
		"inject": Inject,
	}

	*a = toID[y]

	return nil
}

func (a OnMissingAction) MarshalYAML() (interface{}, error) {
	return a.String(), nil
}
